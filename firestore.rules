rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // A user is an admin if their user document has role == 'admin'.
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // The requesting user is the owner of the data.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    match /users/{userId} {
      // Admins can get any user's profile. Users can only get their own.
      allow get: if isOwner(userId) || isAdmin();

      // Admins can list all users. Non-admins cannot.
      allow list: if isAdmin();
      
      // A user can create their own profile, and an admin can create any user profile.
      allow create: if isOwner(userId) || isAdmin();

      // Admins can update any profile. Users can only update their own.
      // A user cannot change their own role.
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin();
      
      // Admins can delete users. Users can delete their own account.
      allow delete: if isAdmin() || isOwner(userId);
    }

    match /schedules/{scheduleId} {
      // Anyone logged in can see schedules
      allow list, get: if request.auth != null;

      // Only teachers can create schedules, and they must be the owner
      allow create: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher' && request.resource.data.teacherId == request.auth.uid;

      // Only the teacher who created the schedule or an admin can update/delete it
      allow update, delete: if (get(/databases/$(database)/documents/schedules/$(scheduleId)).data.teacherId == request.auth.uid) || isAdmin();
    }
  }
}
