rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Safely check a user's role.
    function isRole(role) {
      let userDocPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(userDocPath) && get(userDocPath).data.role == role;
    }

    // A user is an admin if their user document has role == 'admin'.
    function isAdmin() {
      return isRole('admin');
    }

    // The requesting user is the owner of the data.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    match /users/{userId} {
      // Admins can get any user's profile. Users can only get their own.
      allow get: if isOwner(userId) || isAdmin();

      // Admins can list all users. Non-admins cannot.
      allow list: if isAdmin();
      
      // A user can create their own profile, and an admin can create any user profile.
      allow create: if isOwner(userId) || isAdmin();

      // Admins can update any profile. Users can only update their own.
      // A user cannot change their own role.
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin();
      
      // Admins can delete users. Users can delete their own account.
      allow delete: if isAdmin() || isOwner(userId);

      match /attendance/{attendanceId} {
        // A user can create/read/update/delete their own attendance records.
        allow read, write: if isOwner(userId);
      }
    }

    match /schedules/{scheduleId} {
      // Anyone logged in can see schedules
      allow list, get: if request.auth != null;

      // Only teachers or admins can create schedules. Teachers must be the owner.
      allow create: if (isRole('teacher') && request.resource.data.teacherId == request.auth.uid) || isRole('admin');

      // Only the teacher who created the schedule or an admin can update/delete it
      allow update, delete: if (resource.data.teacherId == request.auth.uid) || isAdmin();
    }
  }
}
